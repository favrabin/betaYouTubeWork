<!DOCTYPE html>
<html>
  <head>
    <title>My YouTube Tracker</title>
  </head>
  <body>
    <h1>मेरो YouTube भिडियो</h1>
    <iframe id="ytplayer" width="560" height="315" 
      src="https://www.youtube.com/embed/-blU88b5SmE?enablejsapi=1" 
      frameborder="0" allowfullscreen>
    </iframe>

    <!-- यहाँबाट script सुरु हुन्छ -->
    <script>
      let totalWatchTime = 0;
      let watchStart = null;
      let user = new URLSearchParams(window.location.search).get("user") || "unknown";
      const videoId = "-blU88b5SmE";
      const webhookUrl = "https://script.google.com/macros/s/AKfycbwSmHSvKrcznFbPzHnSxNxXjOOa5RhJm53Oc54YQ-FTUGY1L1lbpbW0QGcLb81DvUiDpw/exec";

      function getOS() {
        let platform = navigator.platform.toLowerCase();
        if (platform.includes("win")) return "Windows";
        if (platform.includes("mac")) return "Mac";
        if (platform.includes("linux")) return "Linux";
        return "Unknown";
      }

      function onYouTubeIframeAPIReady() {
        const player = new YT.Player("ytplayer", {
          events: {
            onStateChange: onPlayerStateChange
          }
        });
      }

      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
          watchStart = Date.now();
        } else if (
          event.data === YT.PlayerState.PAUSED ||
          event.data === YT.PlayerState.ENDED
        ) {
          if (watchStart) {
            const watched = Math.floor((Date.now() - watchStart) / 1000);
            totalWatchTime += watched;
            watchStart = null;
            sendWatchData();
          }
        }
      }

      function sendWatchData() {
        const params = new URLSearchParams({
          user: user,
          watchTime: totalWatchTime,
          browser: navigator.userAgent,
          os: getOS(),
          videoId: videoId
        });

        fetch(`${webhookUrl}?${params.toString()}`)
          .then(response => console.log("Data sent"))
          .catch(error => console.error("Send failed", error));
      }

      // Load YouTube API
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.body.appendChild(tag);
    </script>
  </body>
</html>
